<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Weather Probability Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #7c3aed;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
            gap: 0;
        }

        /* ---- Header / Navbar ---- */
    header {
      background: #1e40af;
      color: #fff;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .header-content {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo-title h1 {
      font-size: 1.2rem;
      margin-bottom: 0.3rem;
    }
    .nasa-badge {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 1.5rem;
      margin: 0;
      padding: 0;
    }
    nav ul li a {
      text-decoration: none;
      color: #fff;
      font-weight: 500;
      transition: color 0.3s;
    }
    nav ul li a:hover,
    nav ul li a.active {
      color: #f59e0b;
    }
    .mobile-menu-btn {
      display: none;
      font-size: 1.5rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      nav ul {
        display: none;
        flex-direction: column;
        background: #1e40af;
        position: absolute;
        top: 70px;
        right: 20px;
        width: 200px;
        padding: 1rem;
        border-radius: 8px;
      }
      nav ul.active { display: flex; }
      .mobile-menu-btn { display: block; }
    }

  

/*header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.6s ease-out;
            position: sticky;
            top: 0;
            z-index: 1000;
        }*/

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /*.header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }*/

       /* h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }*/

       /* nasa-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }*/

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideInLeft 0.6s ease-out;
            max-height: calc(100vh - 100px);
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .main-content {
            padding: 2rem;
            overflow-y: auto;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .control-section {
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        .control-section:nth-child(1) { animation-delay: 0.1s; }
        .control-section:nth-child(2) { animation-delay: 0.2s; }
        .control-section:nth-child(3) { animation-delay: 0.3s; }
        .control-section:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group {
            position: relative;
            margin-bottom: 1rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e5e7eb;
            transform: translateX(5px);
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 0.75rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        #map {
            height: 400px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            animation: zoomIn 0.8s ease-out;
            z-index: 1;
            position: relative;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: scaleIn 0.5s ease-out backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            animation: fadeInUp 0.8s ease-out;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .loading-spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        .loading-spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--primary);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--accent);
        }

        .download-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .download-btn {
            flex: 1;
            min-width: 150px;
            background: var(--success);
        }

        .download-btn:hover {
            background: #059669;
        }

        .mobile-menu-btn {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
        }

        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                width: 300px;
                height: 100vh;
                z-index: 2000;
                transition: left 0.3s ease;
                max-height: 100vh;
            }

            .sidebar.active {
                left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1500;
            }

            .overlay.active {
                display: block;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 1rem;
            }

            #map {
                height: 300px;
            }
        }

        .summary-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .summary-panel h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .summary-item {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }
         /* ---- Footer ---- */
    footer {
      background: #1f2937;
      color: #fff;
      text-align: center;
      padding: 1rem;
      margin-top: auto;
    }

    /*---extra animations---*/
    /* --- Marker Bounce Animation --- */
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-12px);
    }
    60% {
        transform: translateY(-6px);
    }
}

/* --- Sidebar Slide --- */
.sidebar {
    transition: left 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* --- Overlay Fade --- */
.overlay {
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* --- Mobile Menu Button Hover --- */
.mobile-menu-btn:hover {
    transform: scale(1.1);
    transition: transform 0.3s ease;
}

/* --- Stat Card Hover Animation --- */
.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* --- Button Ripple Effect --- */
.btn::after {
    content: '';
    position: absolute;
    width: 100px;
    height: 100px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    background: rgba(255, 255, 255, 0.2);
    opacity: 0;
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(1);
    transition: transform 0.5s ease, opacity 1s ease;
}
.btn:active::after {
    transform: translate(-50%, -50%) scale(3);
    opacity: 0.5;
    transition: 0s;
}

/* --- Chart Fade-In --- */
.chart-container {
    animation: fadeInUp 0.8s ease-out;
}

/* --- Summary Panel Slide-In --- */
.summary-panel {
    animation: fadeInUp 0.8s ease-out;
}

/* --- Input Focus Animation --- */
input:focus, select:focus {
    transform: scale(1.02);
}

/* --- Alert Slide-In --- */
.alert {
    animation: slideInDown 0.6s ease-out;
}

/* --- Loading Spinner Rotation --- */
.loading-spinner {
    animation: spin 1s linear infinite;
}

/* --- Hover Animations for Checkbox Items --- */
.checkbox-item:hover {
    transform: translateX(5px) scale(1.02);
}

/* --- Map Popup Fade-In --- */
.leaflet-popup-content-wrapper {
    animation: fadeIn 0.4s ease-out;
}

/* --- Smooth Gradient Background Animation --- */
body {
    background: linear-gradient(135deg, #667eea, #764ba2, #667eea);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* --- Map Marker Hover Animation --- */
.custom-marker div {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.custom-marker div:hover {
    transform: scale(1.2) translateY(-5px);
    box-shadow: 0 8px 12px rgba(30, 64, 175, 0.5);
}

/* --- Input Field Hover and Focus --- */
input, select {
    transition: all 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
}
input:hover, select:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 10px rgba(30, 64, 175, 0.2);
}
input:focus, select:focus {
    transform: scale(1.04);
    border-color: var(--primary);
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
}

/* --- Label / Placeholder Animation --- */
.input-group input::placeholder {
    transition: opacity 0.3s ease;
}
.input-group input:focus::placeholder {
    opacity: 0.5;
}

/* --- Smooth Hover for Buttons --- */
.btn:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 12px 20px rgba(30, 64, 175, 0.4);
}
.btn:active {
    transform: translateY(0) scale(1);
}

/* --- Sidebar Control Section Animation --- */
.control-section {
    transition: transform 0.4s ease, opacity 0.4s ease;
}
.control-section:hover {
    transform: translateX(5px);
    opacity: 0.95;
}

/* --- Tooltip Effect for Inputs --- */
.input-group input[title] {
    position: relative;
}
.input-group input[title]:hover::after {
    content: attr(title);
    position: absolute;
    top: -28px;
    left: 0;
    background: var(--primary);
    color: #fff;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 1;
    transition: opacity 0.3s ease;
}

/* --- Map Marker Hover Animation --- */

.custom-marker {
    cursor: pointer;
}

.custom-marker div {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Hover effect for marker */

.custom-marker:hover div {
    transform: scale(1.3) translateY(-8px);
    box-shadow: 0 10px 15px rgba(30, 64, 175, 0.5);
    z-index: 1000;
}
@keyframes fadeDown {
    0% {
        opacity: 1;
        transform: translateY(-10px);
    }
    100% {
        opacity: 0;
        transform: translateY(0);
    }
}

    </style>
</head>
<body>
        <!-- Header / Navbar -->
  <header>
    <div class="header-content">
      <div class="logo-title">
        <h1>üåç NASA Weather Dashboard</h1>
        <div class="nasa-badge">
          <span>GSOY Data ‚Ä¢ 1763-Present</span>
        </div>
      </div>
      <nav>
        
        
        <ul id="navLinks">
          <li><a href="index.html" >Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="weather-dashboard.html"class="active">Dashboard</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>
    <div class="dashboard-container">
        <!--<header>
            <div class="header-content">
                <h1>üåç NASA Weather Probability Dashboard</h1>
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
                <div class="nasa-badge">
                    <span>GSOY Data ‚Ä¢ 1763-Present</span>
                </div>
            </div>
        </header>-->
     

        <aside class="sidebar" id="sidebar">
            <div class="control-section">
                <h3 class="section-title">üìç Location Search</h3>
                <div class="input-group">
                    <input type="text" id="locationSearch" placeholder="Enter city or coordinates" aria-label="Location search">
                </div>
                <div class="input-group">
                    <input type="text" id="latitude" placeholder="Latitude" readonly aria-label="Latitude">
                </div>
                <div class="input-group">
                    <input type="text" id="longitude" placeholder="Longitude" readonly aria-label="Longitude">
                </div>
            </div>

            <div class="control-section">
                <h3 class="section-title">üìÖ Date Range</h3>
                <div class="input-group">
                    <label for="startYear">Start Year</label>
                    <input type="number" id="startYear" min="1763" max="2025" value="2020" aria-label="Start year">
                </div>
                <div class="input-group">
                    <label for="endYear">End Year</label>
                    <input type="number" id="endYear" min="1763" max="2025" value="2024" aria-label="End year">
                </div>
            </div>

            <div class="control-section">
                <h3 class="section-title">üå°Ô∏è Weather Variables</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" value="TAVG" checked>
                        <span>Temperature (Avg)</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="PRCP">
                        <span>Precipitation</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="SNOW">
                        <span>Snowfall</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="TMAX">
                        <span>Max Temperature</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="TMIN">
                        <span>Min Temperature</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="AWND">
                        <span>Wind Speed</span>
                    </label>
                </div>
            </div>

            <div class="control-section">
                <button class="btn" id="analyzeBtn">üîç Analyze Weather Data</button>
            </div>

            <div class="control-section">
                <h3 class="section-title">üíæ Download Data</h3>
                <div class="download-section">
                    <button class="btn download-btn" id="downloadCSV">CSV</button>
                    <button class="btn download-btn" id="downloadJSON">JSON</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="alert alert-info">
                <strong>Welcome!</strong> Select a location on the map, choose your date range and weather variables, then click "Analyze Weather Data" to view historical probabilities.
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>

            <div id="map"></div>

            <div class="summary-panel" id="summaryPanel" style="display: none;">
                <h3>üìä Analysis Summary</h3>
                <div id="summaryContent"></div>
            </div>

            <div class="cards-grid" id="statsCards">
                <div class="stat-card">
                    <div class="stat-label">Selected Location</div>
                    <div class="stat-value" id="locationName">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Years Analyzed</div>
                    <div class="stat-value" id="yearsAnalyzed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Data Points</div>
                    <div class="stat-value" id="dataPoints">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Variables</div>
                    <div class="stat-value" id="variableCount">0</div>
                </div>
            </div>

            <div class="loading-spinner" id="loadingSpinner"></div>

            <div class="chart-container" id="chartContainer" style="display: none;">
                <h3 class="chart-title">üìà Historical Weather Probability Distribution</h3>
                <canvas id="probabilityChart"></canvas>
            </div>

            <div class="chart-container" id="timeSeriesContainer" style="display: none;">
                <h3 class="chart-title">üìâ Time Series Analysis</h3>
                <canvas id="timeSeriesChart"></canvas>
            </div>
        </main>
    </div>

    <div class="overlay" id="overlay"></div>
    <!-- Footer -->
  <footer>
    <p>¬© 2025 NASA Weather Dashboard 
    </p>
  </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>
        // State Management
        const state = {
            selectedLocation: null,
            weatherData: {},
            marker: null
        };

        // Initialize Map - Wait for DOM to be fully loaded
        let map;
        
        setTimeout(() => {
            map = L.map('map').setView([40.7128, -74.0060], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Force map to resize properly
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            setupMapHandlers();
        }, 100);

        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });

        // Map Click Handler
        function setupMapHandlers() {
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                
                if (state.marker) {
                    map.removeLayer(state.marker);
                }
                
                state.marker = L.marker([lat, lng], {
                    draggable: true,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #1e40af; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: bounce 0.5s;"></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                state.marker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    document.getElementById('latitude').value = pos.lat.toFixed(4);
                    document.getElementById('longitude').value = pos.lng.toFixed(4);
                });
                
                state.selectedLocation = { lat, lng };
                fetchLocationName(lat, lng);
            });
        }

        // Fetch Location Name
        async function fetchLocationName(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const data = await response.json();
                const locationName = data.address.city || data.address.town || data.address.village || data.address.county || 'Unknown Location';
                document.getElementById('locationName').textContent = locationName;
                document.getElementById('locationSearch').value = locationName;
            } catch (error) {
                console.error('Error fetching location name:', error);
                document.getElementById('locationName').textContent = `${lat}, ${lng}`;
            }
        }

        // Location Search
        document.getElementById('locationSearch').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    const data = await response.json();
                    if (data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        map.setView([lat, lng], 10);
                        
                        if (state.marker) {
                            map.removeLayer(state.marker);
                        }
                        
                        state.marker = L.marker([lat, lng], {
                            draggable: true,
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #1e40af; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>',
                                iconSize: [30, 30]
                            })
                        }).addTo(map);
                        
                        document.getElementById('latitude').value = lat.toFixed(4);
                        document.getElementById('longitude').value = lng.toFixed(4);
                        state.selectedLocation = { lat: lat.toFixed(4), lng: lng.toFixed(4) };
                        fetchLocationName(lat, lng);
                    }
                } catch (error) {
                    console.error('Error searching location:', error);
                    alert('Location not found. Please try again.');
                }
            }
        });

        // Analyze Button
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            if (!state.selectedLocation) {
                alert('Please select a location on the map first!');
                return;
            }

            const checkboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one weather variable!');
                return;
            }

            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);

            if (startYear > endYear) {
                alert('Start year must be before end year!');
                return;
            }

            // Show loading
            document.getElementById('loadingSpinner').classList.add('active');
            
            // Simulate data generation (in real app, this would call NOAA API)
           await generateWeatherData(checkboxes, startYear, endYear);
           //await fetchNASAData(state.selectedLocation.lat, state.selectedLocation.lng, checkboxes, startYear, endYear);

            
            // Hide loading
            document.getElementById('loadingSpinner').classList.remove('active');
            
            // Update stats
            document.getElementById('yearsAnalyzed').textContent = endYear - startYear + 1;
            document.getElementById('dataPoints').textContent = (endYear - startYear + 1) * checkboxes.length;
            document.getElementById('variableCount').textContent = checkboxes.length;
            
            // Show charts
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('timeSeriesContainer').style.display = 'block';
            document.getElementById('summaryPanel').style.display = 'block';
            
           // updateCharts();
           // updateSummary();
           updateCharts();
           updateSummary();

        });

        // Generate Weather Data (Simulated - Replace with NOAA API)
        async function generateWeatherData(checkboxes, startYear, endYear) {
            state.weatherData = {};
            
            checkboxes.forEach(checkbox => {
                const variable = checkbox.value;
                const data = [];
                
                for (let year = startYear; year <= endYear; year++) {
                    let value;
                    switch(variable) {
                        case 'TAVG':
                            value = 15 + Math.random() * 10 - 5; // 10-20¬∞C
                            break;
                        case 'TMAX':
                            value = 25 + Math.random() * 15 - 5; // 20-35¬∞C
                            break;
                        case 'TMIN':
                            value = 5 + Math.random() * 10 - 5; // 0-10¬∞C
                            break;
                        case 'PRCP':
                            value = Math.random() * 1000; // 0-1000mm
                            break;
                        case 'SNOW':
                            value = Math.random() * 200; // 0-200cm
                            break;
                        case 'AWND':
                            value = Math.random() * 20; // 0-20 m/s
                            break;
                        default:
                            value = Math.random() * 100;
                    }
                    
                    data.push({ year, value });
                }
                
                state.weatherData[variable] = data;
            });
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
        }

        // Update Charts
        let probabilityChart, timeSeriesChart;

        function updateCharts() {
            const variables = Object.keys(state.weatherData);
            
            // Probability Distribution Chart
            const ctx1 = document.getElementById('probabilityChart');
            if (probabilityChart) {
                probabilityChart.destroy();
            }
            
            const datasets = variables.map((variable, index) => {
                const values = state.weatherData[variable].map(d => d.value);
                const histogram = generateHistogram(values);
                
                const colors = ['#1e40af', '#7c3aed', '#f59e0b', '#10b981', '#ef4444', '#06b6d4'];
                
                return {
                    label: variable,
                    data: histogram,
                    backgroundColor: colors[index % colors.length] + '40',
                    borderColor: colors[index % colors.length],
                    borderWidth: 2,
                    tension: 0.4
                };
            });
            
            probabilityChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Array.from({length: 20}, (_, i) => `${i * 5}%`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Probability Distribution of Weather Variables'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Value Percentile'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            // Time Series Chart
            const ctx2 = document.getElementById('timeSeriesChart');
            if (timeSeriesChart) {
                timeSeriesChart.destroy();
            }
            
            const timeDatasets = variables.map((variable, index) => {
                const colors = ['#1e40af', '#7c3aed', '#f59e0b', '#10b981', '#ef4444', '#06b6d4'];
                
                return {
                    label: variable,
                    data: state.weatherData[variable].map(d => ({x: d.year, y: d.value})),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                };
            });
            
            timeSeriesChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    datasets: timeDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Time Series Analysis'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Generate Histogram
        function generateHistogram(values) {
            const sorted = [...values].sort((a, b) => a - b);
            const bins = 20;
            const histogram = new Array(bins).fill(0);
            
            values.forEach(value => {
                const percentile = (sorted.indexOf(value) / sorted.length) * 100;
                const binIndex = Math.min(Math.floor(percentile / (100 / bins)), bins - 1);
                histogram[binIndex]++;
            });
            
            return histogram;
        }

        // Update Summary
        function updateSummary() {
            const variables = Object.keys(state.weatherData);
            let summaryHTML = '';
            
            variables.forEach(variable => {
                const values = state.weatherData[variable].map(d => d.value);
                const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2);
                const max = Math.max(...values).toFixed(2);
                const min = Math.min(...values).toFixed(2);
                const stdDev = calculateStdDev(values).toFixed(2);
                
                let unit = '';
                switch(variable) {
                    case 'TAVG':
                    case 'TMAX':
                    case 'TMIN':
                        unit = '¬∞C';
                        break;
                    case 'PRCP':
                        unit = 'mm';
                        break;
                    case 'SNOW':
                        unit = 'cm';
                        break;
                    case 'AWND':
                        unit = 'm/s';
                        break;
                }
                
                summaryHTML += `
                    <div class="summary-item">
                        <strong>${getVariableName(variable)}</strong><br>
                        Average: ${avg}${unit} | Max: ${max}${unit} | Min: ${min}${unit} | Std Dev: ${stdDev}
                    </div>
                `;
            });
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
        }

        function getVariableName(code) {
            const names = {
                'TAVG': 'Average Temperature',
                'TMAX': 'Maximum Temperature',
                'TMIN': 'Minimum Temperature',
                'PRCP': 'Precipitation',
                'SNOW': 'Snowfall',
                'AWND': 'Average Wind Speed'
            };
            return names[code] || code;
        }

        function calculateStdDev(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // Download Functions
        document.getElementById('downloadCSV').addEventListener('click', function() {
            if (Object.keys(state.weatherData).length === 0) {
                alert('Please analyze data first!');
                return;
            }
            
            const variables = Object.keys(state.weatherData);
            let csv = 'Year,' + variables.join(',') + '\n';
            
            const years = state.weatherData[variables[0]].map(d => d.year);
            years.forEach(year => {
                let row = [year];
                variables.forEach(variable => {
                    const dataPoint = state.weatherData[variable].find(d => d.year === year);
                    row.push(dataPoint ? dataPoint.value.toFixed(2) : '');
                });
                csv += row.join(',') + '\n';
            });
            
            // Add metadata
            csv += '\n\nMetadata\n';
            csv += `Location,${state.selectedLocation.lat},${state.selectedLocation.lng}\n`;
            //csv += `Source,NOAA GSOY Dataset\n`;
            csv += `Source,NASA POWER Dataset\n`;
            csv += `Generated,${new Date().toISOString()}\n`;
            
            downloadFile(csv, 'weather-data.csv', 'text/csv');
        });

        document.getElementById('downloadJSON').addEventListener('click', function() {
            if (Object.keys(state.weatherData).length === 0) {
                alert('Please analyze data first!');
                return;
            }
            
            const data = {
                metadata: {
                    location: state.selectedLocation,
                    locationName: document.getElementById('locationName').textContent,
                    //source: 'NOAA GSOY Dataset',
                    source: 'NASA POWER Dataset',
                    generated: new Date().toISOString(),
                    variables: Object.keys(state.weatherData)
                },
                data: state.weatherData
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'weather-data.json', 'application/json');
        });

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        //added extra

        // Fetch Real NASA POWER Data (Annual averages)

async function fetchNASAData(lat, lon, checkboxes, startYear, endYear) {
  state.weatherData = {};

  const variablesMap = {
    'TAVG': 'T2M',
    'TMAX': 'T2M_MAX',
    'TMIN': 'T2M_MIN',
    'PRCP': 'PRECTOTCORR',
    'AWND': 'WS10M',
    'SNOW': 'SNOW'
  };

  const selectedParamsArray = Array.from(checkboxes)
    .map(cb => variablesMap[cb.value])
    .filter(Boolean);

  if (selectedParamsArray.length === 0) {
    alert('No valid variables selected for NASA POWER.');
    return;
  }

  const selectedParams = selectedParamsArray.join(',');
  const url = `https://power.larc.nasa.gov/api/temporal/annual/point?parameters=${selectedParams}&community=RE&longitude=${lon}&latitude=${lat}&start=${startYear}&end=${endYear}&format=JSON`;

  console.log("üåç NASA API URL:", url);

  try {
    const response = await fetch(url);

    if (!response.ok) {
      const text = await response.text();
      throw new Error(`HTTP ${response.status}: ${text}`);
    }

    const json = await response.json();

    if (!json.properties || !json.properties.parameter) {
      throw new Error("Unexpected response structure from NASA POWER API");
    }

    const params = json.properties.parameter;

    for (const [key, yearlyData] of Object.entries(params)) {
      const variable = Object.keys(variablesMap).find(k => variablesMap[k] === key);
      if (!variable) continue;

      const formattedData = Object.entries(yearlyData).map(([year, value]) => ({
        year: parseInt(year),
        value: parseFloat(value)
      }));

      state.weatherData[variable] = formattedData;
    }

    console.log("‚úÖ NASA Data loaded successfully:", state.weatherData);

    // üî• Corrected call
    updateCharts();
    updateSummary();

  } catch (error) {
    console.error("‚ùå NASA fetch error:", error);
    alert(`Failed to fetch NASA data.\n\nReason: ${error.message}`);
  }
}


    </script>
</body>
</html>